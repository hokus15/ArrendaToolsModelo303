import unittest

from arrendatools.modelo303.datos import Modelo303Datos, Periodo
from arrendatools.modelo303.factory import Modelo303Factory


class GeneradorEjercicio2025TestCase(unittest.TestCase):
    def setUp(self):
        self.anyo_fiscal = 2025
        # Datos base v√°lidos
        self.datos_validos = {
            "periodo": Periodo.TERCER_TRIMESTRE,
            "version": "v1.0",
            "nif_empresa_desarrollo": "12345678X",
            "nombre_fiscal_contribuyente": "DE LOS PALOTES PERICO",
            "nif_contribuyente": "12345678E",
            "base_imponible": 2000.00,
        }

    def test_generar_modelo_123T_cuota_positiva(self):
        expected_result = "<T303020253T0000><AUX>                                                                      v1.0    12345678X                                                                                                                                                                                                                     </AUX><T30301000> U12345678EDE LOS PALOTES PERICO                                                           20253T22322222200000000 20000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000200000021000000000000004200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001750000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000005000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </T30301000><T30303000>0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000420001000000000000000042000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000042000                0000000000000000000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </T30303000><T303DID00>           ES0012341234123412341234                                                                                                                                                   0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </T303DID00></T303020253T0000>"  # noqa
        self.datos_validos["iban"] = "ES0012341234123412341234"

        datos_modelo = Modelo303Datos(**self.datos_validos)
        modelo = Modelo303Factory.obtener_generador_modelo303(self.anyo_fiscal)
        datos_fichero = modelo.generar(datos_modelo)
        self.assertEqual(datos_fichero, expected_result)

    def test_generar_modelo_123T_cuota_negativa(self):
        expected_result = "<T303020253T0000><AUX>                                                                      v1.0    12345678X                                                                                                                                                                                                                     </AUX><T30301000> C12345678EDE LOS PALOTES PERICO                                                           20253T22322222200000000 200000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000002000000210000000000000042000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017500000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000000042000000000000002500000000000000005250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000052500N0000000000010500000000000000000000000000000000000000000000000000000000000005000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </T30301000><T30303000>0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000N000000000001050010000N00000000000105000000000000000000000000000000000000000000000000000000000000000000000000000000000000000N00000000000105000000000000000000000000000000000000N0000000000010500                0000000000000000000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </T30303000><T303DID00>                                                                                                                                                                                      0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </T303DID00></T303020253T0000>"  # noqa
        self.datos_validos["iban"] = "ES0012341234123412341234"
        self.datos_validos["gastos_bienes_servicios"] = 2500.0
        self.datos_validos["iva_gastos_bienes_servicios"] = 525.0

        datos_modelo = Modelo303Datos(**self.datos_validos)
        modelo = Modelo303Factory.obtener_generador_modelo303(self.anyo_fiscal)
        datos_fichero = modelo.generar(datos_modelo)
        self.assertEqual(datos_fichero, expected_result)

    def test_generar_modelo_4T_cuota_positiva(self):
        expected_result = "<T303020254T0000><AUX>                                                                      v1.0    12345678X                                                                                                                                                                                                                     </AUX><T30301000> U12345678EDE LOS PALOTES PERICO                                                           20254T22322222200000000 21100000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000200000021000000000000004200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001750000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000005000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </T30301000><T30303000>0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000420001000000000000000042000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000042000                0000000000000000000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </T30303000><T30304000> A018612                                    0000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </T30304000><T30305000>    0000000000000000000000000000000000 00000   0000000000000000000000000000000000 00000   0000000000000000000000000000000000 00000   0000000000000000000000000000000000 00000   0000000000000000000000000000000000 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </T30305000><T303DID00>           ES0012341234123412341234                                                                                                                                                   0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </T303DID00></T303020254T0000>"  # noqa
        self.datos_validos["iban"] = "ES0012341234123412341234"
        self.datos_validos["periodo"] = Periodo.CUARTO_TRIMESTRE
        self.datos_validos["volumen_anual_operaciones"] = 6000.0

        datos_modelo = Modelo303Datos(**self.datos_validos)
        modelo = Modelo303Factory.obtener_generador_modelo303(self.anyo_fiscal)
        datos_fichero = modelo.generar(datos_modelo)
        self.assertEqual(datos_fichero, expected_result)

    def test_generar_modelo_4T_cuota_negativa(self):
        expected_result = "<T303020254T0000><AUX>                                                                      v1.0    12345678X                                                                                                                                                                                                                     </AUX><T30301000> D12345678EDE LOS PALOTES PERICO                                                           20254T22322222200000000 211000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000002000000210000000000000042000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017500000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000000042000000000000002500000000000000005250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000052500N0000000000010500000000000000000000000000000000000000000000000000000000000005000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </T30301000><T30303000>0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000N000000000001050010000N00000000000105000000000000000000000000000000000000000000000000000000000000000000000000000000000000000N00000000000105000000000000000000000000000000000000N0000000000010500                0000000000000000000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </T30303000><T30304000> A018612                                    0000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </T30304000><T30305000>    0000000000000000000000000000000000 00000   0000000000000000000000000000000000 00000   0000000000000000000000000000000000 00000   0000000000000000000000000000000000 00000   0000000000000000000000000000000000 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </T30305000><T303DID00>                                                                                                                                                                                      0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </T303DID00></T303020254T0000>"  # noqa
        self.datos_validos["iban"] = "ES0012341234123412341234"
        self.datos_validos["periodo"] = Periodo.CUARTO_TRIMESTRE
        self.datos_validos["gastos_bienes_servicios"] = 2500.0
        self.datos_validos["iva_gastos_bienes_servicios"] = 525.0
        self.datos_validos["volumen_anual_operaciones"] = 6000.0

        datos_modelo = Modelo303Datos(**self.datos_validos)
        modelo = Modelo303Factory.obtener_generador_modelo303(self.anyo_fiscal)
        datos_fichero = modelo.generar(datos_modelo)
        self.assertEqual(datos_fichero, expected_result)

    def test_generar_modelo_sin_iban(self):
        expected_result = "<T303020253T0000><AUX>                                                                      v1.0    12345678X                                                                                                                                                                                                                     </AUX><T30301000> I12345678EDE LOS PALOTES PERICO                                                           20253T22322222200000000 20000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000200000021000000000000004200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001750000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000005000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </T30301000><T30303000>0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000420001000000000000000042000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000042000                0000000000000000000000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </T30303000><T303DID00>                                                                                                                                                                                      0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </T303DID00></T303020253T0000>"  # noqa

        datos_modelo = Modelo303Datos(**self.datos_validos)
        modelo = Modelo303Factory.obtener_generador_modelo303(self.anyo_fiscal)
        datos_fichero = modelo.generar(datos_modelo)
        self.assertEqual(datos_fichero, expected_result)

    def test_generar_did_con_iban_none(self):
        self.datos_validos["iban"] = None

        datos_modelo = Modelo303Datos(**self.datos_validos)
        modelo = Modelo303Factory.obtener_generador_modelo303(self.anyo_fiscal)
        did = modelo._generar_dp303_did(datos_modelo)

        expected_prefix = "<T303DID00>" + (" " * 45)
        self.assertTrue(did.startswith(expected_prefix))

    def test_tipo_declaracion_cuota_cero(self):
        self.datos_validos["base_imponible"] = 0.0

        datos_modelo = Modelo303Datos(**self.datos_validos)
        modelo = Modelo303Factory.obtener_generador_modelo303(self.anyo_fiscal)

        self.assertEqual(modelo._tipo_declaracion(datos_modelo), "N")

    def test_convertir_a_centimos_negativo(self):
        modelo = Modelo303Factory.obtener_generador_modelo303(self.anyo_fiscal)

        self.assertEqual(modelo._convertir_a_centimos_zfill(-12.34, 5), "N1234")
        centimos = modelo._convertir_a_centimos_str(-1.23)
        self.assertTrue(centimos.startswith("N"))
        self.assertEqual(len(centimos), 17)


if __name__ == "__main__":
    unittest.main()
